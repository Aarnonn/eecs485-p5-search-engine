#!/bin/bash
#
# index
#
# Start/stop/restart/status for Index Server

# Stop on errors
set -Eeuo pipefail
set -x

# Function to check if a specific index server is running
is_server_running() {
    local port=$1
    pgrep -f "flask --app index run --host 0.0.0.0 --port ${port}" > /dev/null 2>&1
}

# Function to start index servers
start_servers() {
    # Check if any servers are already running
    if is_server_running 9000 || is_server_running 9001 || is_server_running 9002; then
        echo "Error: index server is already running"
        exit 1
    fi
    
    echo "starting index server ..."
    
    # Create log directory
    mkdir -p var/log
    
    # Remove old log file
    rm -f var/log/index.log
    
    # Start three index servers on ports 9000, 9001, 9002
    INDEX_PATH="index_server/index/inverted_index/inverted_index_0.txt" \
        flask --app index run --host 0.0.0.0 --port 9000 \
        >> var/log/index.log 2>&1 &
    
    INDEX_PATH="index_server/index/inverted_index/inverted_index_1.txt" \
        flask --app index run --host 0.0.0.0 --port 9001 \
        >> var/log/index.log 2>&1 &
    
    INDEX_PATH="index_server/index/inverted_index/inverted_index_2.txt" \
        flask --app index run --host 0.0.0.0 --port 9002 \
        >> var/log/index.log 2>&1 &
}

# Function to stop index servers
stop_servers() {
    echo "stopping index server ..."
    
    # Kill all index servers (use || true to avoid error if process doesn't exist)
    pkill -f "flask --app index run --host 0.0.0.0 --port 9000" || true
    pkill -f "flask --app index run --host 0.0.0.0 --port 9001" || true
    pkill -f "flask --app index run --host 0.0.0.0 --port 9002" || true
}

# Function to check status
check_status() {
    set +o pipefail
    NPROCS=$(pgrep -f "flask --app index run --host 0.0.0.0 --port 900[0-2]" | wc -l | tr -d ' ')
    set -o pipefail
    
    if [ "$NPROCS" -eq 3 ]; then
        echo "index server running"
        exit 0
    elif [ "$NPROCS" -eq 0 ]; then
        echo "index server stopped"
        exit 1
    else
        echo "index server error: found ${NPROCS} processes, expected 3"
        exit 2
    fi
}

# Parse command line arguments
case $1 in
    start)
        start_servers
        ;;
    stop)
        stop_servers
        ;;
    restart)
        stop_servers
        start_servers
        ;;
    status)
        check_status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac
